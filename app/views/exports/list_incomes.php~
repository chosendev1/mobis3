<?php
require_once('common.php');
//LICENCE
require_once("spl_license/rsa.class");
require_once("spl_license/class.base32.php");
function evalKey()
{
	
	$rsa = New SecurityRSA;
	$b32 = New Base32;
	/*
	$fp=fopen("hard.txt", "w+");
	fclose($fp);
	system("hardware_print.exe >hard.txt");
	$hardware_print = file_get_contents("hard.txt");
	*/
	$file_name = "hard_".rand().".txt";
	$fp=fopen($file_name, "w+");
	fclose($fp);
	$cmd = "hardware_print.exe >".$file_name;
	//system("hardware_print.exe >hard.txt");
	system($cmd);
	//$hardware_print = file_get_contents("hard.txt");
	$hardware_print = file_get_contents($file_name);
	@unlink($file_name);

	$row = @mysql_fetch_array(@mysql_query("select branch_name, branch_no from branch order by branch_no asc limit 1"));
	
	$sacco_name = strtoupper($row['branch_name']);
	$sacco_print = $hardware_print . $sacco_name;
	$hwpr = sha1($sacco_print);
	$length = strlen($hwpr) - 1;
	$seq = "";
	for ($i = 0; $i < $length; $i++)
	{
		$str1 = substr($hwpr, $i, 1);
		$str2 = substr($hwpr, ($i + 1), 1);
		$char = (intval($str1) > intval($str2))? 0 : 1 ;
		$seq .= $char;
	
	}
	$seq .= "1";
	$client_id = "";

	for ($j = 0; $j < $length; $j+=4)
	{
		$client_id .= base_convert(substr($seq, $j, 4), 2, 16);
	}
	$client_id = strtoupper($client_id);
	$row = mysql_fetch_array(mysql_query("select * from flt_key order by id desc limit 1"));
	$sub_license = strtoupper($row['license_key']);
	//$sub_license = strtoupper($key1) . strtoupper($key2) . strtoupper($key3) . strtoupper($key4);
	$date = $sub_license{2} . $sub_license{5} . $sub_license{8} . $sub_license{11} . $sub_license{14} . $sub_license{15};
	$text = $client_id . $date;

	$n = 57264617;
	$e = 7603;
	$keys = array($n, $e);
	$b32->setCharset($b->csSafe);
	$encoded = $rsa->rsa_encrypt($text, $keys[1], $keys[0]);
	$key = $b32->fromString($encoded);
	$keysum = sha1($key);
	$keylen = strlen($keysum);
	$seq2 = "";

	for ($i = 0; $i < $keylen; $i++)
	{
        $str1 = substr($keysum, $i, 1);
        $str2 = substr($keysum, ($i + 1), 1);
        $char = (intval($str1) > intval($str2))? 0 : 1 ;
        $seq2 .= $char;

	}
	$seq2 .= "1";
	for ($j = 0; $j < $keylen; $j+=4)
	{
        $rkey .= base_convert(substr($seq2, $j, 4), 2, 16);
	}
	$ack1 = substr($rkey, 0, 2);
	$ack2 = substr($rkey, 2, 2);
	$ack3 = substr($rkey, 4, 2);
	$ack4 = substr($rkey, 6, 2);
	$ack5 = substr($rkey, 8);
	//$ack5 = $rkey{9};
	$date1 = $date{0};
	$date2 = $date{1};
	$date3 = $date{2};
	$date4 = $date{3};
	$date5 = substr($date, 4);
	$actual_key = $ack1 . $date1.$ack2.$date2.$ack3.$date3.$ack4.$date4.$ack5.$date5;
	$fkey .= substr($sub_license, 0, 4) . "-" . substr($sub_license, 4, 4) . "-" . substr($sub_license, 8, 4) . "-" . substr($sub_license, 12);
	if ((strtoupper($sub_license) != strtoupper($actual_key)) || (date('ymd') >= $date))
	{
		header("Location: home2.php");
		exit();
	}
}
//evalKey();
if($_SESSION['user_id'] ==0 || !isset($_SESSION['user_id']))
	header("Location: index.php");

if(!isset($_GET['format']))
echo("<head>
	<title>SAVINGS PLUS v 2.0 : SAVINGS PRODUCT ACCOUNTS FOR MEMBERS</title>
		<style>
.headings{ color:#ffffff; background-color:#00008b;}
	</style>
	</head><body>");

//LIST SAVINGS PRODUCT ACCOUNTS FOR MEMBERS
function listIncome($account, $contact, $from_year, $from_month, $from_mday, $to_year, $to_month, $to_mday, $format,$branch_id)
{
	$branch_res = mysql_query("select * from branch");
	$branch = mysql_fetch_array($branch_res);
	$branch_ = ($branch_id=='all'||$branch_id=='')?NULL:"and r.branch_id=".$branch_id;
	$content .= "<center><p><font color=#00008b size=4pt><b>".$branch['branch_name']."</b></font></p></center>";
	$content = "<center><font color=#00008b size=3pt><b>LIST OF OTHER INCOME</b></font></center><br>";
	if($from_year ==''){
		$content .="<table height=100 border='1' cellpadding='0' cellspacing='0' style='border-collapse: collapse' bordercolor='#111111' width='100%' id='AutoNumber2' align=center>
		<tr bgcolor=lightgrey><td><font color=red>Select the period for the income!</font></td></tr></table>";
		echo($content);
		return 0;
	}
	$from_date = sprintf("%d-%02d-%02d 00:00:00", $from_year, $from_month, $from_mday);
	$to_date = sprintf("%d-%02d-%02d 23:59:59",  $to_year, $to_month, $to_mday);
	if ($account == '')
	{
		$res = @mysql_query("select r.bank_account, ac.id as acc_id, ac.name as acc_name, ac.account_no as account_no, r.id as rid, r.amount as amount, r.contact as contact, r.date as mdate, r.contact as contact, r.receipt_no, r.cheque_no, r.mode from accounts ac right join other_income r on r.account_id = ac.id where r.date>= '".$from_date."' and r.date <= '".$to_date."' and r.contact like '%".$contact."%' ".$branch_." order by r.date desc");
	}else{
		$res = @mysql_query("select r.bank_account, ac.id as acc_id, ac.name as acc_name, ac.account_no as account_no, r.id as rid, r.amount as amount, r.contact as contact, r.date as mdate, r.contact as contact, r.receipt_no, r.cheque_no, r.mode from accounts ac right join other_income r on r.account_id = ac.id where r.date>= '".$from_date."' and r.date <= '".$to_date."' and r.account_id='".$account."' and r.contact like '%".$contact."%' ".$branch_." order by r.date desc");
	}
	
	if (@mysql_num_rows($res) > 0)
	{
		$content .= "
			   <table height=100 border='1' cellpadding='0' cellspacing='1' style='border-collapse: collapse' bordercolor='#111111' width='80%' id='AutoNumber2' align=LEFT>
			    <tr class='headings'>
			        <th>Date</th><th>Account</th><th>Amount</th><th>Receipt No./Cheque No.</th><th>Payment Mode</th><th>Contact Person</th><th>Bank Account</th>
			    </tr>
			    ";
		$i=0;
		while ($fxrow = @mysql_fetch_array($res))
		{
			//if (strtolower($type) == 'all' || strtolower($type) == 'cleared')
			//{
			$mode = ($fxrow['mode'] == 'cash') ? $fxrow['mode'] : 'Offset from Savings' ;
			$color = ($i%2 == 0) ? "lightgrey" : "white";
			$bank = mysql_fetch_array(mysql_query("select b.bank as bank, a.name as name, a.account_no from bank_account b join accounts a on b.account_id=a.id where b.id='".$fxrow['bank_account']."'"));
			$content .= "
				    <tr bgcolor=$color>
				        <td>".$fxrow['mdate']."</td><td>$fxrow[account_no] - $fxrow[acc_name]</td><td>".number_format($fxrow[amount], 2)."</td><td>$fxrow[receipt_no] $fxrow[cheque_no]</td><td>$mode</td><td>$fxrow[contact]</td><td>".$bank['account_no'] ."-". $bank['bank']." ".$bank['name']."</td>
				    </tr>
				    ";	
					$balance += $fxrow['amount'];
			//}
			$i++;
		}
		$content .= "<tr class='headings'><th colspan=2>Total </th><th colspan=5>".number_format($balance, 2)."</th></tr></table>";
	}
	else
		$content .= "<table height=100 border='1' cellpadding='0' cellspacing='0' style='border-collapse: collapse' bordercolor='#111111' width='70%' id='AutoNumber2' align=center><tr><td><font color=red>No Income registered yet.</font><br></td></tr></table>";
	
	export($format, $content);
}
//reports_header();
//listIncome($_GET['account'], $_GET['contact'], $_GET['from_year'], $_GET['from_month'], $_GET['from_mday'], $_GET'to_year'], $_GET['to_month'], $_GET['to_mday']);
listIncome($_GET['account'], $_GET['contact'], $_GET['from_year'], $_GET['from_month'], $_GET['from_mday'], $_GET['to_year'], $_GET['to_month'], $_GET['to_mday'], $_GET['format'],$_GET['branch_id']);
//reports_footer();

?>